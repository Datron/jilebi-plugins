const t="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36 ModelContextProtocol/1.0.0 (AWS Documentation Server)",e=crypto.randomUUID(),n=[{terms:["neuron","neuron sdk"],domains:[{key:"domain",value:"awsdocs-neuron.readthedocs-hosted.com"}],regex:/^https?:\/\/awsdocs-neuron\.readthedocs-hosted\.com\//}],o=[/^https?:\/\/docs\.aws\.amazon\.com\//,...n.map(t=>t.regex)],r=[];async function read_documentation(n,s){try{const{url:c,max_length:i=5e3,start_index:a=0}=n;if(!c)return{content:[{type:"text",text:"URL is required"}],isError:!0};if(!function isValidDocumentationUrl(t){return o.some(e=>e.test(t))}(c))return{content:[{type:"text",text:`Invalid URL: ${c}. URL must be from list of supported domains`}],isError:!0};if(!c.endsWith(".html"))return{content:[{type:"text",text:`Invalid URL: ${c}. URL must end with .html`}],isError:!0};if(i<=0||i>=1e6)return{content:[{type:"text",text:"max_length must be between 1 and 1000000"}],isError:!0};if(a<0)return{content:[{type:"text",text:"start_index must be non-negative"}],isError:!0};let u=`${c}?session=${e}`;const l=function getQueryIdFromCache(t){for(const e of r)for(const n of e.search_results)if(n.url===t)return encodeURIComponent(e.query_id);return null}(c);l&&(u+=`&query_id=${l}`);const d=await fetch(u,{headers:{"User-Agent":s.MCP_USER_AGENT||t,"X-MCP-Session-Id":e}});if(!d.ok)return{content:[{type:"text",text:`Failed to fetch ${c} - status code ${d.status}`}],isError:!0};const m=await d.text();let f;f=function isHtmlContent(t,e){return t.slice(0,100).includes("<html")||e.includes("text/html")||!e}(m,d.headers.get("content-type")||"")?html2markdown(m):m;const h=function formatDocumentationResult(t,e,n,o){const r=e.length;if(n>=r)return`AWS Documentation from ${t}:\n\n<e>No more content available.</e>`;const s=Math.min(n+o,r),c=e.slice(n,s);if(!c)return`AWS Documentation from ${t}:\n\n<e>No more content available.</e>`;const i=c.length;let a=`AWS Documentation from ${t}:\n\n${c}`;r-(n+i)>0&&(a+=`\n\n<e>Content truncated. Call the read_documentation tool with start_index=${n+i} to get more content.</e>`);return a}(c,f,a,i);return{content:[{type:"text",text:h}]}}catch(t){return{content:[{type:"text",text:`Failed to read documentation: ${t instanceof Error?t.message:String(t)}`}],isError:!0}}}async function search_documentation(o,s){try{const{search_phrase:c,search_intent:i="",limit:a=10,product_types:u,guide_types:l}=o;if(!c||!c.trim())return{content:[{type:"text",text:"search_phrase is required"}],isError:!0};const d=Math.min(Math.max(1,a),50),m={textQuery:{input:c.trim()},contextAttributes:[{key:"domain",value:"docs.aws.amazon.com"}],acceptSuggestionBody:"RawText",locales:["en_us"]};for(const t of n)t.terms.some(t=>c.toLowerCase().includes(t))&&m.contextAttributes.push(...t.domains);if(u)for(const t of u)m.contextAttributes.push({key:"aws-docs-search-product",value:t});if(l)for(const t of l)m.contextAttributes.push({key:"aws-docs-search-guide",value:t});let f=`https://proxy.search.docs.aws.amazon.com/search?session=${e}`;f=function addSearchIntentToSearchRequest(t,e){if(e&&e.trim()){const n=e.split(/\s+/).join(" ").trim();if(n)return`${t}&search_intent=${encodeURIComponent(n)}`}return t}(f,i);const h=await fetch(f,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":s.MCP_USER_AGENT||t,"X-MCP-Session-Id":e},body:JSON.stringify(m)});if(!h.ok){return{content:[{type:"text",text:`Error searching AWS docs - status code ${h.status}`}],isError:!0}}let p;try{p=await h.json()}catch(t){return{content:[{type:"text",text:`Error parsing search results: ${t instanceof Error?t.message:String(t)}`}],isError:!0}}const x=p.queryId||"",y=p.facets,g={};y&&(y["aws-docs-search-product"]&&(g.product_types=y["aws-docs-search-product"]),y["aws-docs-search-guide"]&&(g.guide_types=y["aws-docs-search-guide"]));const $=[],_=p.suggestions;if(_)for(let t=0;t<Math.min(_.length,d);t++){const e=_[t];if(e.textExcerptSuggestion){const n=e.textExcerptSuggestion;let o=null;const r=n.metadata||{};r.seo_abstract?o=r.seo_abstract:r.abstract?o=r.abstract:n.summary?o=n.summary:n.suggestionBody&&(o=n.suggestionBody),$.push({rank_order:t+1,url:n.link||"",title:n.title||"",context:o})}}const E={search_results:$,facets:Object.keys(g).length>0?g:null,query_id:x};!function addSearchResultCacheItem(t){r.unshift(t),r.length>3&&r.pop()}(E);let S=`# Search Results for: "${c}"\n\n`;if(S+=`Query ID: ${x}\n\n`,0===$.length)S+="No results found.\n";else{S+=`Found ${$.length} result(s)\n\n`;for(const t of $)S+=`## ${t.rank_order}. ${t.title}\n`,S+=`**URL:** ${t.url}\n\n`,t.context&&(S+=`${t.context}\n\n`),S+="---\n\n"}return E.facets&&(S+="## Available Filters\n\n",E.facets.product_types&&(S+=`**Product Types:** ${E.facets.product_types.join(", ")}\n\n`),E.facets.guide_types&&(S+=`**Guide Types:** ${E.facets.guide_types.join(", ")}\n\n`)),{content:[{type:"text",text:S}]}}catch(t){return{content:[{type:"text",text:`Search failed: ${t instanceof Error?t.message:String(t)}`}],isError:!0}}}async function recommend(n,o){try{const{url:r}=n;if(!r)return{content:[{type:"text",text:"URL is required"}],isError:!0};const s=`https://contentrecs-api.docs.aws.amazon.com/v1/recommendations?path=${r}&session=${e}`,c=await fetch(s,{headers:{"User-Agent":o.MCP_USER_AGENT||t}});if(!c.ok)return{content:[{type:"text",text:`Error getting recommendations - status code ${c.status}`}],isError:!0};let i;try{i=await c.json()}catch(t){return{content:[{type:"text",text:`Error parsing recommendations: ${t instanceof Error?t.message:String(t)}`}],isError:!0}}const a=function parseRecommendationResults(t){const e=[],n=t.highlyRated;if(n?.items)for(const t of n.items)e.push({url:t.url||"",title:t.assetTitle||"",context:t.abstract||null});const o=t.journey;if(o?.items)for(const t of o.items){const n=t.intent||"";if(t.urls)for(const o of t.urls)e.push({url:o.url||"",title:o.assetTitle||"",context:n?`Intent: ${n}`:null})}const r=t.new;if(r?.items)for(const t of r.items){const n=t.dateCreated||"";e.push({url:t.url||"",title:t.assetTitle||"",context:n?`New content added on ${n}`:"New content"})}const s=t.similar;if(s?.items)for(const t of s.items)e.push({url:t.url||"",title:t.assetTitle||"",context:t.abstract||"Similar content"});return e}(i);if(0===a.length)return{content:[{type:"text",text:`No recommendations found for: ${r}`}]};const u=[],l=[],d=[],m=[];for(const t of a)t.context?.startsWith("Intent:")?l.push(t):t.context?.startsWith("New content")?d.push(t):"Similar content"===t.context?m.push(t):u.push(t);let f=`# Recommendations for: ${r}\n\n`;if(f+=`Found ${a.length} recommendation(s)\n\n`,u.length>0){f+="## Highly Rated\n\n";for(const t of u)f+=`- [${t.title}](${t.url})`,t.context&&(f+=` - ${t.context}`),f+="\n";f+="\n"}if(l.length>0){f+="## Journey (Next Steps)\n\n";for(const t of l)f+=`- [${t.title}](${t.url})`,t.context&&(f+=` - ${t.context}`),f+="\n";f+="\n"}if(d.length>0){f+="## New Content\n\n";for(const t of d)f+=`- [${t.title}](${t.url})`,t.context&&(f+=` - ${t.context}`),f+="\n";f+="\n"}if(m.length>0){f+="## Similar\n\n";for(const t of m)f+=`- [${t.title}](${t.url})`,t.context&&(f+=` - ${t.context}`),f+="\n";f+="\n"}return{content:[{type:"text",text:f}]}}catch(t){return{content:[{type:"text",text:`Failed to get recommendations: ${t instanceof Error?t.message:String(t)}`}],isError:!0}}}export{recommend as get_recommendations,read_documentation,recommend,search_documentation};
